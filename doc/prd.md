# äº§å“éœ€æ±‚æ–‡æ¡£ (PRD): Solana Constant Product AMM

## 1. é¡¹ç›®æ¦‚è§ˆ

**é¡¹ç›®åç§°ï¼š** Sol-AMM
**ç›®æ ‡ï¼š** åœ¨ Solana ä¸Šå®ç°ä¸€ä¸ªåŸºäº $x \cdot y = k$ ç®—æ³•çš„å»ä¸­å¿ƒåŒ–äº¤æ˜“å¯¹åè®®ã€‚

**æ ¸å¿ƒæŒ‘æˆ˜ï¼š** ä» EVM çš„"åˆçº¦å­˜å‚¨"æ¨¡å¼åˆ‡æ¢åˆ° SVM çš„"è´¦æˆ·éš”ç¦»"æ¨¡å¼ï¼Œå¹¶ç¡®ä¿èµ„é‡‘å®‰å…¨ã€‚

## 2. ç³»ç»Ÿæ¶æ„ (Technical Architecture)

### 2.1 è´¦æˆ·æ¨¡å‹è®¾è®¡ (The "Account Map")

è¿™æ˜¯ Solana å¼€å‘çš„æ ¸å¿ƒã€‚æˆ‘ä»¬å°†é‡‡ç”¨ **æ•°æ®ä¸æƒé™è§£è€¦** çš„é«˜çº§æ¶æ„ã€‚

| è´¦æˆ·åç§° | ç±»å‹ | ç§å­ (Seeds) | èŒè´£ |
| --------- | ------ | ------------ | ------ |
| Pool State | Data Account | `["pool", mint_a, mint_b]` | å­˜å‚¨æ± å­çŠ¶æ€ï¼ˆtoken_a, token_b, vaults, lp_mint, è´¹ç‡ã€Bumpsï¼‰ã€‚ |
| Pool Authority | PDA (Signer) | `["authority"]` | å……å½“é‡‘åº“æ‰€æœ‰è€…å’Œ LP é“¸é€ è€…ï¼Œä¸å­˜æ•°æ®ã€‚ä½¿ç”¨å…¨å±€ç§å­ï¼Œæ‰€æœ‰æ± å­å…±äº«åŒä¸€ä¸ª Authorityã€‚ |
| Vault A/B | Token Account | - | é€šè¿‡ `init` åˆ›å»ºçš„ Associated Token Accountsï¼Œå®é™…å­˜å‚¨ä»£å¸ A å’Œ Bï¼ŒOwner ä¸º Pool Authorityã€‚ |
| LP Mint | Mint Account | - | é€šè¿‡ `init` åˆ›å»ºçš„ Mint è´¦æˆ·ï¼Œå‘è¡ŒæµåŠ¨æ€§å‡­è¯ï¼ˆdecimals=9ï¼‰ï¼ŒMint Authority ä¸º Pool Authorityã€‚ |

### 2.2 æ ¸å¿ƒä¸šåŠ¡æµç¨‹

#### Initialize (åˆå§‹åŒ–) âœ… å·²å®ç°

- è¾“å…¥ï¼š`mint_a: Pubkey`, `mint_b: Pubkey`, `fee_numerator: u64`, `fee_denominator: u64`
- éªŒè¯ï¼š
  - å¼ºåˆ¶ `mint_a < mint_b`ï¼Œé˜²æ­¢åŒä¸€ä¸ªä»£å¸å¯¹å‡ºç°ä¸¤ä¸ªæ± å­
  - éªŒè¯è´¹ç‡åˆæ³•æ€§ï¼š`fee_denominator > 0 && fee_numerator < fee_denominator`
- é€»è¾‘ï¼š
  - ä½¿ç”¨ seeds `["pool", mint_a, mint_b]` åˆ›å»º Pool State PDA
  - åˆ›å»º Pool Authority PDAï¼ˆseeds: `["authority"]`ï¼‰
  - åˆå§‹åŒ– Token A/B Vaultsï¼ˆAssociated Token Accountsï¼‰
  - åˆå§‹åŒ– LP Mintï¼ˆdecimals=9ï¼‰
  - å­˜å‚¨æ‰€æœ‰è´¦æˆ·åœ°å€ã€è´¹ç‡ã€Bumps åˆ° PoolState

#### Add Liquidity (æä¾›æµåŠ¨æ€§)

- é€»è¾‘ï¼šç”¨æˆ·å­˜å…¥ A å’Œ Bï¼Œç¨‹åºæ ¹æ®å½“å‰æ¯”ä¾‹è®¡ç®—åº”å¢å‘çš„ LP ä»£å¸ã€‚

#### Swap (äº¤æ¢) ğŸš§ è¿›è¡Œä¸­

- è¾“å…¥ï¼š`amount_in: u64`
- è´¦æˆ·ç»“æ„ï¼šå·²å®šä¹‰ `Swap` Contextï¼ŒåŒ…å« pool_stateã€user_token_a/bã€token_a/b_vaultã€pool_authority
- å¾…å®ç°é€»è¾‘ï¼š
  - ç¡®è®¤ swap æ–¹å‘ï¼ˆAâ†’B æˆ– Bâ†’Aï¼‰
  - è·å–å½“å‰æ± å­ä½™é¢
  - è®¡ç®—æ‰‹ç»­è´¹ï¼ˆä» amount_in ä¸­æ‰£é™¤ï¼‰
  - ä½¿ç”¨ u128 è®¡ç®— amount_outï¼ˆé˜²æ­¢æº¢å‡ºï¼‰
  - æ»‘ç‚¹ä¿æŠ¤æ£€æŸ¥
  - æ‰§è¡Œä»£å¸åˆ’è½¬ï¼ˆé€šè¿‡ pool_authority PDA ç­¾åï¼‰

#### Remove Liquidity (æ’¤å‡ºæµåŠ¨æ€§)

- é€»è¾‘ï¼šç”¨æˆ·é”€æ¯ LPï¼Œç¨‹åºæŒ‰æ¯”ä¾‹ä» Vaults è¿”è¿˜ A å’Œ Bã€‚

## 3. åŠŸèƒ½éœ€æ±‚ (Functional Requirements)

### 3.1 æ ¸å¿ƒæŒ‡ä»¤ (Instructions)

**initialize** âœ…: è®¾ç½®æ± å­å…ƒæ•°æ®ï¼Œåˆå§‹åŒ– PDA è´¦æˆ·ã€‚å·²å®ç°å®Œæ•´çš„éªŒè¯é€»è¾‘å’Œè´¦æˆ·åˆ›å»ºã€‚

**add_liquidity**:

- è¾“å…¥ï¼šamount_a, max_amount_b (æˆ–æŒ‰æ¯”ä¾‹)ã€‚
- äº§å‡ºï¼šMint LP Token ç»™ç”¨æˆ·ã€‚

**swap** ğŸš§:

- è¾“å…¥ï¼š`amount_in: u64`ï¼ˆæ»‘ç‚¹ä¿æŠ¤å‚æ•°å¾…æ·»åŠ ï¼‰
- è´¦æˆ·ç»“æ„ï¼šå·²å®šä¹‰ï¼ŒåŒ…å«å®Œæ•´çš„è´¦æˆ·éªŒè¯çº¦æŸ
- å…¬å¼ï¼š$\Delta y = \frac{y \cdot \Delta x \cdot (1 - fee)}{x + \Delta x \cdot (1 - fee)}$
- çŠ¶æ€ï¼šå‡½æ•°æ¡†æ¶å·²åˆ›å»ºï¼Œæ ¸å¿ƒé€»è¾‘å¾…å®ç°

**remove_liquidity**:

- è¾“å…¥ï¼šlp_amountã€‚
- äº§å‡ºï¼šè¿”è¿˜å¯¹åº”çš„ä»£å¸ A å’Œ Bã€‚

## 4. éåŠŸèƒ½éœ€æ±‚ & å®‰å…¨è®¾è®¡ (Non-functional & Security)

### 4.1 å®‰å…¨çº¦æŸ (Crucial for Junior-to-Senior Transition)

- **æ’åº Mint éªŒè¯**ï¼šå¼ºåˆ¶ mint_a < mint_bï¼Œé˜²æ­¢åŒä¸€ä¸ªä»£å¸å¯¹å‡ºç°ä¸¤ä¸ªæ± å­ã€‚
- **è´¦æˆ·å…³è”æ£€æŸ¥**ï¼šä½¿ç”¨ Anchor çº¦æŸï¼ˆ`has_one`ï¼‰ç¡®ä¿ä¼ å…¥çš„ vault åœ°å€ä¸ pool_state ä¸­å­˜å‚¨çš„åœ°å€åŒ¹é…ã€‚
- **ç”¨æˆ·ä»£å¸éªŒè¯**ï¼šéªŒè¯ç”¨æˆ·ä»£å¸è´¦æˆ·çš„ mint ä¸æ± å­ä¸­çš„ token_a/token_b åŒ¹é…ã€‚
- **æƒé™æ ¡éªŒ**ï¼šæ‰€æœ‰æ¶‰åŠèµ„é‡‘åˆ’è½¬çš„ CPI å¿…é¡»é€šè¿‡ pool_authority çš„ PDA ç­¾åã€‚
- **ç²¾åº¦å¤„ç†**ï¼šä½¿ç”¨ u128 è¿›è¡Œä¸­é—´è¿ç®—ï¼Œéµå¾ª"å…ˆä¹˜åé™¤"åŸåˆ™ï¼Œé˜²æ­¢ç²¾åº¦æŸå¤±è¢«é»‘å®¢å¥—åˆ©ã€‚

### 4.2 æ•°å­¦æ¨¡å‹

- ä½¿ç”¨ **æ’å®šä¹˜ç§¯å…¬å¼**ï¼š$(x + \Delta x) \cdot (y - \Delta y) = k$ã€‚
- **æ‰‹ç»­è´¹**ï¼šé€šè¿‡ `fee_numerator` å’Œ `fee_denominator` å®ç°ï¼Œåœ¨ `initialize` æ—¶è®¾ç½®ã€‚éªŒè¯è§„åˆ™ï¼š`fee_denominator > 0 && fee_numerator < fee_denominator`ã€‚
- **ç²¾åº¦å¤„ç†**ï¼šswap è®¡ç®—ä½¿ç”¨ u128 è¿›è¡Œä¸­é—´è¿ç®—ï¼Œé˜²æ­¢ u64 æº¢å‡ºã€‚
- **Bump å­˜å‚¨**ï¼šPoolState ä¸­å­˜å‚¨ `pool_bump` å’Œ `auth_bump`ï¼Œé¿å…è¿è¡Œæ—¶é‡å¤è°ƒç”¨ `find_program_address`ï¼Œæå‡æ€§èƒ½ã€‚

## 5. å¼€å‘è¿›åº¦è¡¨ (14-Day Sprint)

| å‘¨æœŸ | ä»»åŠ¡ | æ¨¡å— | äº§å‡ºç‰© | çŠ¶æ€ |
| ------ | ------ | ------ | -------- | ------ |
| Q1 | åœ°åŸºæ­å»º | - | lib.rs ç»“æ„å®šä¹‰ã€Initialize æŒ‡ä»¤ã€å•å…ƒæµ‹è¯•ã€‚ | âœ… å·²å®Œæˆ |
| Q2 | Swap æ ¸å¿ƒ | - | swap æŒ‡ä»¤å®ç°ã€æ•°å­¦ç®—æ³•å·¥å…·ç±»ã€æ»‘ç‚¹ä¿æŠ¤æ£€æŸ¥ã€‚ | ğŸš§ è¿›è¡Œä¸­ |
| Q3 | æµåŠ¨æ€§æ¨¡å— | - | add_liquidity / remove_liquidity æŒ‡ä»¤ã€‚ | â³ æœªå¼€å§‹ |
| Q4 | é›†æˆä¸äº¤ä»˜ | - | TS å†’çƒŸæµ‹è¯•ã€AI è¾…åŠ© React å‰ç«¯ã€è½¬æ­£æŠ€æœ¯æ–‡æ¡£ã€‚ | â³ æœªå¼€å§‹ |

**å½“å‰å®ç°çŠ¶æ€ï¼š**

- âœ… **å·²å®Œæˆ**ï¼š
  - `PoolState` è´¦æˆ·ç»“æ„å®šä¹‰ï¼ˆåŒ…å«æ‰€æœ‰å¿…è¦å­—æ®µå’Œ LEN è®¡ç®—ï¼‰
  - `Initialize` æŒ‡ä»¤å®Œæ•´å®ç°ï¼ˆåŒ…å«éªŒè¯é€»è¾‘ã€è´¦æˆ·åˆ›å»ºã€Bump å­˜å‚¨ï¼‰
  - `Swap` è´¦æˆ·ç»“æ„å®šä¹‰ï¼ˆåŒ…å«å®Œæ•´çš„çº¦æŸéªŒè¯ï¼‰
  - é”™è¯¯ç±»å‹å®šä¹‰ï¼ˆ`AmmError`ï¼šInvalidMint, InvalidFee, InvalidVault, InvalidUserTokenï¼‰
- ğŸš§ **è¿›è¡Œä¸­**ï¼š
  - `swap` å‡½æ•°æ¡†æ¶å·²åˆ›å»ºï¼Œæ ¸å¿ƒé€»è¾‘å¾…å®ç°ï¼ˆæ•°å­¦è®¡ç®—ã€æ»‘ç‚¹ä¿æŠ¤ã€ä»£å¸åˆ’è½¬ï¼‰
- â³ **å¾…å®ç°**ï¼š
  - `add_liquidity` æŒ‡ä»¤
  - `remove_liquidity` æŒ‡ä»¤
  - æ•°å­¦å·¥å…·ç±»ï¼ˆ`math.rs` æ–‡ä»¶å·²åˆ›å»ºä½†ä¸ºç©ºï¼‰

## 6. æˆåŠŸæ ‡å‡† (Definition of Done)

- **ä»£ç å±‚é¢**ï¼šanchor test è¦†ç›–ç‡è¾¾åˆ° 80% ä»¥ä¸Šï¼Œæ— è´¦æˆ·éªŒè¯æ¼æ´ã€‚
- **äº¤äº’å±‚é¢**ï¼šå‰ç«¯å¯è¿æ¥ Phantom é’±åŒ…ï¼Œå®Œæˆä¸€ç¬”å®Œæ•´çš„ Swapã€‚
- **æ–‡æ¡£å±‚é¢**ï¼šèƒ½å¤Ÿè§£é‡Š PDA ç§å­è®¾è®¡çš„åŸå› å’Œå®‰å…¨æ•°å­¦çš„å®ç°ç»†èŠ‚ã€‚
